<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Munchkin Boo</title>

  <style>
    :root{
      --bg:#050A1A;
      --card:#0B1433;
      --text:#F4F6FF;
      --muted:#A8B1D9;
      --border:#1C2A5E;
      --primary:#7C6CFF;
      --primaryText:#0B0F2A;
      --button:#121C46;
      --buttonHover:#18235C;
      --radius:20px;

      /* ‚úÖ Audio tracks stored in CSS (read by JS) */
      --track-theme:   url("assets/music/theme-music.mp3");
      --track-shooting:url("assets/music/shooting-stars.mp3");
      --track-labour:  url("assets/music/labour-of-love.mp3");
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .wrap{ width:min(520px,100%); }

    /* ‚úÖ Allow a wider ‚Äúbook‚Äù on larger screens */
    @media (min-width: 768px){
      .wrap{ width:min(980px, 100%); }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:26px;
      box-shadow:0 20px 40px rgba(0,0,0,.45);
      position:relative;
    }

    p{ margin:0; line-height:1.7; }
    .muted{ color:var(--muted); line-height:1.6; }
    .card > section > * + * { margin-top:14px; }

    h1{ font-size:1.45rem; margin:0; letter-spacing:.3px; }
    h2{ margin:0; font-size:1.25rem; letter-spacing:.2px; }

    /* ‚úÖ Buttons: shine on hover + pop on press */
    .btn{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--button);
      color:var(--text);
      font-weight:800;
      font-size:1rem;
      cursor:pointer;
      transition:background .15s ease, transform .08s ease, box-shadow .18s ease, filter .18s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      will-change: transform;
    }
    .btn:hover{
      background:var(--buttonHover);
      box-shadow:0 10px 26px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.06) inset;
      filter:brightness(1.06);
    }
    .btn:active{
      transform:translateY(1px) scale(0.985);
      box-shadow:0 6px 16px rgba(0,0,0,.28);
      filter:brightness(1.02);
    }

    .btn.primary{
      background:var(--primary);
      color:var(--primaryText);
      border:none;
    }
    .btn.primary:hover{
      filter:brightness(1.08);
      box-shadow:0 12px 30px rgba(124,108,255,.25), 0 10px 26px rgba(0,0,0,.28);
    }
    .btn.primary:active{
      transform:translateY(1px) scale(0.985);
      box-shadow:0 8px 18px rgba(124,108,255,.18), 0 6px 16px rgba(0,0,0,.26);
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    input{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#0E1840;
      color:var(--text);
      font-size:1rem;
      outline:none;
    }
    input::placeholder{ color:#7F88B8; }

    .hidden{ display:none; }

    .storyBody p{ margin:0 0 12px; }
    .storyBody p:last-child{ margin-bottom:0; }

    /* ----- Soft fade transitions ----- */
    .fadeWrap{
      opacity: 1;
      transform: translateY(0);
      transition: opacity 260ms ease, transform 260ms ease;
      will-change: opacity, transform;
    }
    .fadeWrap.isFading{
      opacity: 0;
      transform: translateY(4px);
    }

    .topRow{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .topRow .btn{ flex:1; }

    .status{
      margin-top:10px;
      font-size:0.85rem;
      color:var(--muted);
      opacity:0.85;
    }

    /* ‚úÖ Top-right icon controls */
    .uiTopBar{
      position:absolute;
      top:14px;
      right:14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin:0;
      flex-wrap:nowrap;
      z-index:5;
    }
    .uiTopBar .btn{
      width:auto;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:1.05rem;
      white-space:nowrap;
      min-width:44px; /* ‚úÖ keeps icon buttons tappable */
    }

    /* ‚úÖ Reserve space so the top-right audio buttons never overlap content */
    .card{
      padding-top: 70px; /* default space for the icon bar */
    }

    /* Keep buttons tucked in tight */
    .uiTopBar{
      top: 12px;
      right: 12px;
    }

    /* ‚úÖ On smaller screens, reserve a bit more space and slightly shrink buttons */
    @media (max-width: 420px){
      .card{
        padding-top: 84px; /* more space for the icon bar */
      }

      .uiTopBar .btn{
        padding: 8px 10px;
        font-size: 1rem;
        min-width: 40px;
      }
    }

    .choiceList{
      margin-top:14px;
      display:grid;
      gap:10px;
    }

    .pill{
      display:inline-block;
      font-size:0.8rem;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      margin-bottom:10px;
    }

    .supportDivider{
      height:1px;
      background:var(--border);
      opacity:0.45;
      margin:18px 0 8px;
    }

    .supportWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      margin-top:6px;
      gap:8px;
    }

    .supportBtn{
      max-width:240px;
      padding:10px 14px;
      font-size:0.70rem;
      font-weight:620;
      background:#141E4A;
      border:1px solid rgba(255,255,255,0.08);
      opacity:0.5;
    }
    .supportBtn:hover{ opacity:1; }

    .copyright{
      margin-top:20px;
      text-align:center;
      font-size:0.7rem;
      color:var(--muted);
      opacity:0.6;
    }

    /* =========================
       üìñ Open-book Story Layout
       ========================= */

    /* The story "page" wrapper */
    .storyLayout{
      display:flex;
      flex-direction:column; /* mobile default */
      gap:16px;
      position:relative;
    }

    /* Left "page" (image) */
    .storyLeft{
      flex:1;
    }

    /* Right "page" (text) */
    .storyRight{
      flex:1;
      min-width:0;
    }

    /* Art */
    .storyArt{
      width:100%;
      aspect-ratio: 4 / 3;   /* a bit more book-like than 1/1 */
      object-fit:cover;
      border-radius:16px;
      display:block;
      border:1px solid var(--border);
      margin:0;
    }

    /* The text area becomes the scrollable panel on larger screens */
    .storyScroll{
      overflow:visible;  /* mobile: normal flow */
    }

    /* ‚úÖ Larger devices: ‚Äúopen book‚Äù */
    @media (min-width: 768px){
      /* give the card a more book-like footprint */
      .card{
        padding-left: 28px;
        padding-right: 28px;
      }

      .storyLayout{
        flex-direction:row;
        align-items:stretch;
        gap:22px;
      }

      .storyLeft{
        width:48%;
      }

      /* üîí Right side height is locked to match the image */
      .storyRight{
        width:52%;
        height:520px;              /* matches image height */
        display:flex;
        flex-direction:column;
        position:relative;
      }

      /* make the image feel big & ‚Äúpage-like‚Äù */
      .storyArt{
        aspect-ratio: 3 / 4;       /* portrait-ish for a page */
        height: 520px;
        max-height: 520px;
      }

      /* scroll only the story text/choices within that height */
      .storyScroll{
        flex:1;
        overflow-y:auto;           /* scrolls exactly at image bottom */
        padding-right:10px;        /* space for scrollbar */
      }

      /* ‚úÖ subtle centre ‚Äúspine‚Äù shadow */
      .storyLayout::after{
        content:"";
        position:absolute;
        top:0;
        bottom:0;
        left:calc(48% + 11px); /* approx center accounting for gap */
        width:22px;
        pointer-events:none;
        background:
          radial-gradient(ellipse at center,
            rgba(0,0,0,.40) 0%,
            rgba(0,0,0,.22) 35%,
            rgba(0,0,0,0) 70%);
        opacity:.55;
        filter:blur(0.2px);
      }
    }

    /* =========================
       üëª Summon Boo Overlay
       ========================= */
    .booOverlay{
      position:fixed;
      inset:0;
      background:rgba(2,4,14,0.72);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }

    .booModal{
      width:min(560px, 100%);
      background:rgba(11,20,51,0.96);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:22px;
      box-shadow:0 26px 60px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }

    .booHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }

    .booTitle{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .booClose{
      width:auto;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:1rem;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(18,28,70,0.7);
      color:var(--text);
      cursor:pointer;
    }
    .booClose:hover{ filter:brightness(1.08); }

    .booBody{
      padding:16px;
      display:grid;
      gap:12px;
    }

    .booLine{
      color:var(--text);
      line-height:1.7;
      white-space:pre-wrap;
    }

    .booChoices{
      display:grid;
      gap:10px;
      margin-top:4px;
    }

    /* ‚ú® Glow widget (used in Follow the Glow scenes) */
    .glowWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 0 2px;
    }
    .glowOrb{
      width:92px;
      height:92px;
      border-radius:999px;
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.65), rgba(124,108,255,.35) 40%, rgba(124,108,255,.10) 70%, rgba(0,0,0,0) 75%);
      border:1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 0 30px rgba(124,108,255,.25),
        0 0 70px rgba(124,108,255,.18);
      transform: scale(0.92);
      opacity:0.95;
    }
    .glowOrb.isBreathing{
      animation: glowBreathe 2.6s ease-in-out infinite;
    }
    @keyframes glowBreathe{
      0%   { transform: scale(0.86); filter:brightness(0.95); }
      45%  { transform: scale(1.03); filter:brightness(1.08); }
      100% { transform: scale(0.86); filter:brightness(0.95); }
    }

    .booHint{
      font-size:0.85rem;
      color:rgba(168,177,217,0.92);
      text-align:center;
      margin-top:-2px;
    }
  </style>
</head>
<script data-goatcounter="https://munchkin-boo-2.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<body>
  <div class="wrap">
    <div class="card">

      <!-- ‚úÖ Top-right icon-only controls -->
      <div class="uiTopBar">
        <button id="summonBtn" class="btn hidden" type="button" aria-label="Summon Boo">üëª</button>
        <button id="trackBtn" class="btn" type="button" aria-label="Change music track">üéµ</button>
        <button id="muteBtn" class="btn" type="button" aria-label="Toggle sound">üîä</button>
      </div>

      <audio id="themePlayer" preload="none"></audio>

      <section id="step1">
        <h1>Hi, I‚Äôm Munchkin Boo ‚ú®üåô</h1>
        <p class="muted">I‚Äôm your personal bedtime story application.</p>
        <p class="muted">Press start to begin.</p>
        <button class="btn primary" id="startBtn" type="button">Start</button>
        <div class="status" id="loadStatus">Loading stories‚Ä¶</div>
        <div class="status" id="audioStatus"></div>
      </section>

      <section id="step2" class="hidden">
        <h1>What‚Äôs your name?</h1>
        <p class="muted">So I can personalise your story.</p>
        <input id="nameInput" placeholder="Type your name‚Ä¶" autocomplete="given-name" />
        <button class="btn primary" id="toMood" type="button">Continue</button>
        <button class="btn" id="backToWelcome" type="button">Back</button>
      </section>

      <section id="step3" class="hidden">
        <h1>What mood are you in?</h1>
        <p class="muted">Choose one:</p>

        <div class="row">
          <button class="btn" data-mood="sleepy" type="button">üò¥ Sleepy</button>
          <button class="btn" data-mood="hungry" type="button">üç™ Hungry</button>
        </div>

        <div class="row">
          <button class="btn" data-mood="naughty" type="button">üòà Naughty</button>
          <button class="btn" data-mood="adventure" type="button">üß≠ Adventure</button>
        </div>

        <button class="btn" id="backToName" type="button">Back</button>
      </section>

      <section id="step4" class="hidden">
        <div class="pill" id="modePill">Story</div>

        <!-- üìñ Book layout wrapper -->
        <div class="storyLayout">
          <!-- Left page: art -->
          <div class="storyLeft">
            <img class="storyArt" id="storyArt" alt="" />
          </div>

          <!-- Right page: title + scrollable story -->
          <div class="storyRight">
            <h2 id="storyTitle"></h2>

            <div class="storyScroll">
              <div class="fadeWrap" id="fadeWrap">
                <div class="storyBody" id="storyBody"></div>
                <div class="choiceList hidden" id="choiceList"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="topRow">
          <button class="btn primary" id="anotherStory" type="button">Another story</button>
          <button class="btn" id="changeMood" type="button">Change mood</button>
        </div>

        <button class="btn" id="restart" type="button">Restart Munchkin Boo</button>
      </section>

      <div class="supportDivider"></div>

      <div class="supportWrap">
      </div>

      <footer class="copyright">
        ¬© <span id="year"></span> James Ritchie and www.boo-industries.com. All rights reserved. Contact: jamesalexritchie@outlook.com
      </footer>

    </div>
  </div>

  <!-- üëª Summon Boo Modal -->
  <div id="booOverlay" class="booOverlay hidden" role="dialog" aria-modal="true" aria-label="Summon Boo">
    <div class="booModal">
      <div class="booHeader">
        <div class="booTitle">üëª <span>Summon Boo</span></div>
        <button id="booCloseBtn" class="booClose" type="button" aria-label="Close Summon Boo">‚úï</button>
      </div>

      <div class="booBody">
        <div id="glowWrap" class="glowWrap hidden">
          <div id="glowOrb" class="glowOrb"></div>
        </div>
        <div id="glowHint" class="booHint hidden">Watch the glow‚Ä¶ in‚Ä¶ and out‚Ä¶</div>

        <div id="booLine" class="booLine"></div>
        <div id="booChoices" class="booChoices"></div>
      </div>
    </div>
  </div>

  <script>
    const state = {
      name: "",
      mood: "",
      stories: [],
      lastStoryIdByMood: {},
      currentInteractiveStory: null,
      currentNodeId: null,

      // audio
      track: localStorage.getItem("munchkin_track") || "theme", // "theme" | "shooting" | "labour"
      audioStarted: localStorage.getItem("munchkin_audio_started") === "true",

      // summon boo
      summon: {
        data: null,
        currentSceneId: "summon_root_1",
        overlayOpen: false,
        previousFocus: null,
        previousVolume: null
      }
    };

    const steps = ["step1","step2","step3","step4"];

    function show(id){
      steps.forEach(s => document.getElementById(s).classList.toggle("hidden", s !== id));
      if (id !== "step4") {
        const choiceList = document.getElementById("choiceList");
        choiceList.classList.add("hidden");
        choiceList.innerHTML = "";
      }

      // üëª Summon Boo button only appears during story time (step4)
      const summonBtn = document.getElementById("summonBtn");
      summonBtn.classList.toggle("hidden", id !== "step4");
    }

    function cleanName(input){
      const trimmed = (input || "").trim();
      const safe = trimmed.replace(/[^a-zA-Z '-]/g, "");
      return safe.slice(0, 30) || "";
    }

    function pickRandom(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function pickStoryForMood(mood){
      const options = state.stories.filter(s => s.mood === mood);
      if (!options.length) return null;

      const lastId = state.lastStoryIdByMood[mood] || null;
      if (options.length === 1) return options[0];

      let picked;
      do { picked = pickRandom(options); }
      while (picked.id === lastId);

      state.lastStoryIdByMood[mood] = picked.id;
      return picked;
    }

    function pickAnotherAdventureStory(){
      const adventures = state.stories.filter(s =>
        s.mood === "adventure" && s.type === "choose_your_own" && s.nodes && s.start
      );
      if (!adventures.length) return null;
      if (adventures.length === 1) return adventures[0];

      const currentId = state.currentInteractiveStory?.id || null;
      const options = adventures.filter(s => s.id !== currentId);
      return options.length ? pickRandom(options) : adventures[0];
    }

    function setModePill(text){
      document.getElementById("modePill").textContent = text;
    }

    function renderArtTitle(story){
      const art = document.getElementById("storyArt");
      art.onerror = () => console.log("Image failed to load:", art.src);
      art.src = story.art || "";
      art.alt = story.title || "";
      document.getElementById("storyTitle").textContent = story.title || "";
    }

    function renderParagraphs(paragraphArray){
      const safeName = state.name || "Friend";
      const body = document.getElementById("storyBody");
      body.innerHTML = (paragraphArray || []).map(p => {
        const filled = String(p).replaceAll("{{name}}", safeName);
        return `<p>${filled}</p>`;
      }).join("");
    }

    function fadeUpdate(renderFn){
      const el = document.getElementById("fadeWrap");
      if (!el) { renderFn(); return; }
      el.classList.add("isFading");
      window.setTimeout(() => {
        renderFn();
        requestAnimationFrame(() => el.classList.remove("isFading"));
      }, 260);
    }

    function startInteractiveStory(story){
      state.currentInteractiveStory = story;
      state.currentNodeId = story.start;

      setModePill("Adventure");
      document.getElementById("anotherStory").textContent = "Another adventure";

      const choiceList = document.getElementById("choiceList");
      choiceList.classList.remove("hidden");

      renderArtTitle(story);
      fadeUpdate(() => renderInteractiveNode(true));
    }

    function renderInteractiveNode(skipFade=false){
      const story = state.currentInteractiveStory;
      if (!story || !story.nodes) return;

      const node = story.nodes[state.currentNodeId];
      if (!node) return;

      const doRender = () => {
        renderParagraphs(node.text || []);

        const choiceList = document.getElementById("choiceList");
        choiceList.innerHTML = "";

        const choices = node.choices || [];
        if (choices.length === 0) {
          choiceList.classList.add("hidden");
        } else {
          choiceList.classList.remove("hidden");
          choices.forEach(ch => {
            const btn = document.createElement("button");
            btn.className = "btn";
            btn.type = "button";
            btn.textContent = ch.label;
            btn.addEventListener("click", () => {
              state.currentNodeId = ch.next;
              renderInteractiveNode();
            });
            choiceList.appendChild(btn);
          });
        }
      };

      if (skipFade) doRender();
      else fadeUpdate(doRender);
    }

    function stopInteractiveStoryState(){
      state.currentInteractiveStory = null;
      state.currentNodeId = null;

      const choiceList = document.getElementById("choiceList");
      choiceList.classList.add("hidden");
      choiceList.innerHTML = "";
    }

    function renderNormalStory(story){
      stopInteractiveStoryState();
      setModePill("Story");
      document.getElementById("anotherStory").textContent = "Another story";

      renderArtTitle(story);
      fadeUpdate(() => renderParagraphs(story.text || []));
    }

    function showNoStories(mood){
      stopInteractiveStoryState();
      setModePill("Story");
      document.getElementById("anotherStory").textContent = "Another story";

      document.getElementById("storyTitle").textContent = "No stories yet";
      fadeUpdate(() => {
        document.getElementById("storyBody").innerHTML =
          `<p class="muted">No stories found for mood: ${mood}</p>`;
      });

      document.getElementById("storyArt").src = "";
      document.getElementById("storyArt").alt = "";
    }

    async function loadStories(){
      const status = document.getElementById("loadStatus");
      try {
        const res = await fetch("./stories.json");
        if (!res.ok) throw new Error("stories.json not found");
        const data = await res.json();
        state.stories = data.stories || [];
        status.textContent = ``;
      } catch (err) {
        console.error(err);
        status.textContent = "Couldn‚Äôt load stories. Check stories.json is in the repo root.";
      }
    }

    // ======================
    // AUDIO (3 tracks)
    // ======================
    const themePlayer = document.getElementById("themePlayer");
    const muteBtn = document.getElementById("muteBtn");
    const trackBtn = document.getElementById("trackBtn");
    const audioStatus = document.getElementById("audioStatus");

    function readCssAudioUrl(varName){
      const raw = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
      return raw.replace(/^url\((['"]?)(.*?)\1\)$/i, "$2");
    }

    const TRACKS = {
      theme:    readCssAudioUrl("--track-theme")   || "assets/music/theme-music.mp3",
      shooting: readCssAudioUrl("--track-shooting")|| "assets/music/shooting-stars.mp3",
      labour:   readCssAudioUrl("--track-labour")  || "assets/music/labour-of-love.wav"
    };

    const TRACK_ORDER = ["theme", "shooting", "labour"];

    themePlayer.addEventListener("error", () => {
      const code = themePlayer.error?.code;
      const msg =
        code === 1 ? "MEDIA_ERR_ABORTED" :
        code === 2 ? "MEDIA_ERR_NETWORK" :
        code === 3 ? "MEDIA_ERR_DECODE (format/codec)" :
        code === 4 ? "MEDIA_ERR_SRC_NOT_SUPPORTED" :
        "Unknown audio error";
      console.log("Audio error:", msg, themePlayer.src);
      audioStatus.textContent = "Audio error: " + msg;
    });

    themePlayer.addEventListener("playing", () => { audioStatus.textContent = ""; });
    themePlayer.addEventListener("waiting", () => { audioStatus.textContent = "Loading sound‚Ä¶"; });

    themePlayer.muted = (localStorage.getItem("munchkin_muted") === "true");

    // ‚úÖ Icon-only mute button
    function updateMuteButton(){
      muteBtn.textContent = themePlayer.muted ? "üîá" : "üîä";
    }
    updateMuteButton();

    // ‚úÖ Icon-only track button (never shows names)
    function updateTrackButton(){
      trackBtn.textContent = "üéµ";
    }
    updateTrackButton();

    muteBtn.addEventListener("click", () => {
      themePlayer.muted = !themePlayer.muted;
      localStorage.setItem("munchkin_muted", themePlayer.muted);
      updateMuteButton();
    });

    function applyTrack(trackKey){
      if (!TRACKS[trackKey]) trackKey = "theme";
      state.track = trackKey;
      localStorage.setItem("munchkin_track", state.track);
      updateTrackButton();

      themePlayer.pause();
      themePlayer.src = TRACKS[trackKey];
      themePlayer.loop = true;
      themePlayer.volume = 0.5;
      themePlayer.load();
    }

    async function tryPlay(){
      try {
        await themePlayer.play();
        audioStatus.textContent = "";
        state.audioStarted = true;
        localStorage.setItem("munchkin_audio_started", "true");
      } catch (err) {
        console.log("Audio blocked:", err);
        audioStatus.textContent = "If sound doesn‚Äôt begin, tap Sound on, then tap Start again.";
      }
    }

    function nextTrackKey(current){
      const i = TRACK_ORDER.indexOf(current);
      return TRACK_ORDER[(i + 1) % TRACK_ORDER.length];
    }

    // ‚úÖ Cycle through 3 tracks, and attempt play (click is user gesture)
    trackBtn.addEventListener("click", async () => {
      const next = nextTrackKey(state.track);
      applyTrack(next);
      if (state.audioStarted) await tryPlay();
    });

    async function startThemeMusic(){
      applyTrack(state.track);
      await tryPlay();
    }

    function stopThemeMusic(){
      themePlayer.pause();
      themePlayer.currentTime = 0;
    }

    // ======================
    // üëª SUMMON BOO (Bedtime)
    // ======================
    const summonBtn = document.getElementById("summonBtn");
    const booOverlay = document.getElementById("booOverlay");
    const booCloseBtn = document.getElementById("booCloseBtn");
    const booLineEl = document.getElementById("booLine");
    const booChoicesEl = document.getElementById("booChoices");
    const glowWrap = document.getElementById("glowWrap");
    const glowOrb = document.getElementById("glowOrb");
    const glowHint = document.getElementById("glowHint");

    // Bedtime Summon scenes (inline so you can ship immediately).
    // If you later want this in a separate file, keep structure identical and fetch it.
    const DEFAULT_SUMMON_DATA = {
      meta: { version: "1.0", firstScene: "summon_root_1" },
      scenes: {
        summon_root_1: {
          lines: ["Hi {{name}}‚Ä¶ I‚Äôm right here üëª\n\nWant a little help getting sleepy?"],
          choices: [
            { label: "Help me get sleepy‚Ä¶", goto: "sleepy_root_1" },
            { label: "Stay close, Boo‚Ä¶", goto: "stay_close_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },

        sleepy_root_1: {
          lines: ["Okay‚Ä¶ soft and slow.\n\nWhat do you want?"],
          choices: [
            { label: "A night whisper", goto: "night_whisper_1" },
            { label: "Follow Boo‚Äôs glow", goto: "glow_1" },
            { label: "A cozy choice", goto: "cozy_choice_1" },
            { label: "A sleepy spell", goto: "sleepy_spell_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },

        night_whisper_1: {
          lines: ["Shhh‚Ä¶ your bed is a little boat.\n\nAnd tonight, it stays perfectly still."],
          choices: [
            { label: "Again", goto: "night_whisper_2" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        night_whisper_2: {
          lines: ["If a thought pops in‚Ä¶ that‚Äôs okay.\n\nBoo can hold it on the outside of the pillow."],
          choices: [
            { label: "Again", goto: "night_whisper_3" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        night_whisper_3: {
          lines: ["Let your eyelids get heavy‚Ä¶ like warm blankets.\n\nNothing to do now. Just rest."],
          choices: [
            { label: "One more time", goto: "night_whisper_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },

        // ‚ú® Follow the Glow (bedtime-friendly micro loop)
        glow_1: {
          meta: { showGlow: true, hint: "Watch the glow‚Ä¶ in‚Ä¶ and out‚Ä¶" },
          lines: ["Okay‚Ä¶ watch Boo‚Äôs little glow.\n\nIn‚Ä¶\n\nAnd out‚Ä¶"],
          choices: [
            { label: "Again", goto: "glow_2" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        glow_2: {
          meta: { showGlow: true, hint: "In‚Ä¶ nice and gentle‚Ä¶ out‚Ä¶ slow and soft‚Ä¶" },
          lines: ["In‚Ä¶ nice and gentle‚Ä¶\n\nOut‚Ä¶ slow and soft‚Ä¶"],
          choices: [
            { label: "Again", goto: "glow_3" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        glow_3: {
          meta: { showGlow: true, hint: "Last one‚Ä¶ in‚Ä¶ and out‚Ä¶" },
          lines: ["Last one‚Ä¶\n\nIn‚Ä¶\n\nAnd out‚Ä¶\n\nGood."],
          choices: [
            { label: "Again", goto: "glow_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },

        cozy_choice_1: {
          lines: ["Where should Boo float?\n\nSomewhere cozy‚Ä¶"],
          choices: [
            { label: "By the blanket", goto: "cozy_blanket_1" },
            { label: "By the window", goto: "cozy_window_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        cozy_blanket_1: {
          lines: ["Okay‚Ä¶ right by the blanket.\n\nIt‚Äôs warm here. Like a quiet hug."],
          choices: [
            { label: "Again", goto: "cozy_blanket_2" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        cozy_blanket_2: {
          lines: ["Your toes can go floppy now.\n\nThen your knees.\n\nThen your cheeks."],
          choices: [
            { label: "Again", goto: "cozy_choice_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        cozy_window_1: {
          lines: ["Okay‚Ä¶ by the window.\n\nThe night is doing its quiet work out there."],
          choices: [
            { label: "Again", goto: "cozy_window_2" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },
        cozy_window_2: {
          lines: ["The room is safe.\n\nThe bed is steady.\n\nYou are sleepy in the best way."],
          choices: [
            { label: "Again", goto: "cozy_choice_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },

        sleepy_spell_1: {
          lines: ["Okay‚Ä¶ say it with Boo (even in your head):\n\nSafe body.\nSoft pillow.\nQuiet room.\nSleepy you."],
          choices: [
            { label: "Say it again", goto: "sleepy_spell_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        },

        stay_close_1: {
          lines: ["I‚Äôm here.\n\nI‚Äôll float nearby‚Ä¶ very quietly."],
          choices: [
            { label: "Follow Boo‚Äôs glow", goto: "glow_1" },
            { label: "Back to the story", goto: "END_RETURN" }
          ]
        }
      }
    };

    function fillTemplate(text){
      const safeName = state.name || "Friend";
      return String(text || "").replaceAll("{{name}}", safeName);
    }

    function setGlowVisible(isVisible, hintText){
      glowWrap.classList.toggle("hidden", !isVisible);
      glowHint.classList.toggle("hidden", !isVisible);

      if (isVisible) {
        glowOrb.classList.add("isBreathing");
        glowHint.textContent = hintText || "Watch the glow‚Ä¶ in‚Ä¶ and out‚Ä¶";
      } else {
        glowOrb.classList.remove("isBreathing");
        glowHint.textContent = "";
      }
    }

    function renderSummonScene(sceneId){
      const data = state.summon.data || DEFAULT_SUMMON_DATA;
      const scene = data.scenes?.[sceneId];

      if (!scene) {
        // fallback: close gently if missing
        closeSummonBoo(true);
        return;
      }

      state.summon.currentSceneId = sceneId;

      // show glow only in glow scenes
      const showGlow = !!scene.meta?.showGlow;
      setGlowVisible(showGlow, scene.meta?.hint);

      // lines
      const lines = (scene.lines || []).map(fillTemplate);
      booLineEl.textContent = lines.join("\n\n");

      // choices
      booChoicesEl.innerHTML = "";
      (scene.choices || []).forEach(ch => {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.type = "button";
        btn.textContent = ch.label;

        btn.addEventListener("click", () => {
          if (ch.goto === "END_RETURN") {
            closeSummonBoo(true);
            return;
          }
          renderSummonScene(ch.goto);
        });

        booChoicesEl.appendChild(btn);
      });
    }

    function openSummonBoo(){
      if (state.summon.overlayOpen) return;

      // Only allow summon during story mode screen
      const isStoryScreen = !document.getElementById("step4").classList.contains("hidden");
      if (!isStoryScreen) return;

      state.summon.overlayOpen = true;
      state.summon.previousFocus = document.activeElement;

      // Soft audio ducking (keeps bedtime feel)
      state.summon.previousVolume = themePlayer.volume;
      themePlayer.volume = Math.max(0.18, themePlayer.volume * 0.45);

      booOverlay.classList.remove("hidden");

      // start at root every time (ritual-like)
      const data = state.summon.data || DEFAULT_SUMMON_DATA;
      renderSummonScene(data.meta?.firstScene || "summon_root_1");

      // focus close for accessibility
      booCloseBtn.focus({ preventScroll: true });
    }

    function closeSummonBoo(restoreFocus){
      if (!state.summon.overlayOpen) return;

      state.summon.overlayOpen = false;
      booOverlay.classList.add("hidden");
      setGlowVisible(false);

      // restore audio volume
      if (typeof state.summon.previousVolume === "number") {
        themePlayer.volume = state.summon.previousVolume;
      }

      // restore focus
      if (restoreFocus && state.summon.previousFocus && state.summon.previousFocus.focus) {
        state.summon.previousFocus.focus({ preventScroll: true });
      } else if (restoreFocus) {
        summonBtn.focus({ preventScroll: true });
      }
    }

    // Optional: load summon scenes from file if you add it later.
    // If fetch fails, we use DEFAULT_SUMMON_DATA.
    async function loadSummonScenes(){
      try {
        const res = await fetch("./munchkin_summon_scenes.json");
        if (!res.ok) throw new Error("munchkin_summon_scenes.json not found");
        const data = await res.json();
        if (data && data.scenes) state.summon.data = data;
      } catch (err) {
        // no problem ‚Äî inline fallback is used
        console.log("Summon scenes: using inline fallback.");
      }
    }

    summonBtn.addEventListener("click", openSummonBoo);
    booCloseBtn.addEventListener("click", () => closeSummonBoo(true));

    // click outside modal closes (gentle + expected)
    booOverlay.addEventListener("click", (e) => {
      const modal = e.target.closest(".booModal");
      if (!modal) closeSummonBoo(true);
    });

    // Esc closes
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && state.summon.overlayOpen) {
        e.preventDefault();
        closeSummonBoo(true);
      }
    });

    // ======================
    // UI wiring
    // ======================
    document.getElementById("startBtn").addEventListener("click", () => {
      startThemeMusic();
      show("step2");
    });

    document.getElementById("backToWelcome").addEventListener("click", () => show("step1"));
    document.getElementById("backToName").addEventListener("click", () => show("step2"));
    document.getElementById("changeMood").addEventListener("click", () => show("step3"));

    document.getElementById("toMood").addEventListener("click", () => {
      const nm = cleanName(document.getElementById("nameInput").value);
      if(!nm) return;
      state.name = nm;
      localStorage.setItem("munchkin_name", nm);
      show("step3");
    });

    document.getElementById("step3").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-mood]");
      if(!btn) return;

      state.mood = btn.getAttribute("data-mood");
      const story = pickStoryForMood(state.mood);

      if(!story){
        showNoStories(state.mood);
        show("step4");
        return;
      }

      if (story.type === "choose_your_own" && story.nodes && story.start) {
        startInteractiveStory(story);
        show("step4");
        return;
      }

      renderNormalStory(story);
      show("step4");
    });

    document.getElementById("anotherStory").addEventListener("click", () => {
      if (state.mood === "adventure") {
        const nextAdventure = pickAnotherAdventureStory();
        if (nextAdventure) startInteractiveStory(nextAdventure);
        return;
      }

      const story = pickStoryForMood(state.mood);
      if (!story) return;

      if (story.type === "choose_your_own" && story.nodes && story.start) {
        startInteractiveStory(story);
      } else {
        renderNormalStory(story);
      }
    });

    document.getElementById("restart").addEventListener("click", () => {
      state.name = "";
      state.mood = "";
      stopInteractiveStoryState();
      document.getElementById("nameInput").value = "";
      stopThemeMusic();

      // if summon is open, close it
      closeSummonBoo(false);

      show("step1");
    });

    document.getElementById("nameInput").value = localStorage.getItem("munchkin_name") || "";
    document.getElementById("year").textContent = new Date().getFullYear();

    // ======================
    // Boot
    // ======================
    loadStories();
    loadSummonScenes(); // optional external file, with inline fallback
    show("step1");
  </script>
</body>
</html>
