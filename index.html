<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Munchkin Boo</title>

  <style>
    :root{
      --bg:#050A1A;
      --card:#0B1433;
      --text:#F4F6FF;
      --muted:#A8B1D9;
      --border:#1C2A5E;
      --primary:#7C6CFF;
      --primaryText:#0B0F2A;
      --button:#121C46;
      --buttonHover:#18235C;
      --radius:20px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .wrap{ width:min(520px,100%); }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:26px;
      box-shadow:0 20px 40px rgba(0,0,0,.45);
      position:relative;
    }

    /* ---------- Typography & spacing polish ---------- */
    p{ margin:0; line-height:1.7; }
    .muted{ color:var(--muted); line-height:1.6; }

    /* Give every element inside a step some breathing room */
    .card > section > * + * { margin-top:14px; }

    h1{ font-size:1.45rem; margin:0; letter-spacing:.3px; }
    h2{ margin:0; font-size:1.25rem; letter-spacing:.2px; }

    /* Keep spacer available, but smaller (less bunched/stacky) */
    .spacer{ height:12px; }

    .btn{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--button);
      color:var(--text);
      font-weight:800;
      font-size:1rem;
      cursor:pointer;
      transition:background .15s ease, transform .05s ease;
      text-decoration:none; /* so <a class="btn"> looks like a button */
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn:hover{ background:var(--buttonHover); }
    .btn:active{ transform:translateY(1px); }

    .btn.primary{
      background:var(--primary);
      color:var(--primaryText);
      border:none;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    input{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#0E1840;
      color:var(--text);
      font-size:1rem;
      outline:none;
    }
    input::placeholder{ color:#7F88B8; }

    .hidden{ display:none; }

    .storyArt{
      width:100%;
      aspect-ratio:1/1;
      object-fit:cover;
      border-radius:16px;
      display:block;
      border:1px solid var(--border);
      margin:0 auto 14px;
    }

    .storyBody p{ margin:0 0 12px; }
    .storyBody p:last-child{ margin-bottom:0; }

    .topRow{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .topRow .btn{ flex:1; }

    /* Status line: smaller, calmer */
    .status{
      margin-top:10px;
      font-size:0.85rem;
      color:var(--muted);
      opacity:0.85;
    }

    .muteBtn{
      position:absolute;
      top:14px;
      right:14px;
      width:auto;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:0.95rem;
    }

    .choiceList{
      margin-top:14px;
      display:grid;
      gap:10px;
    }

    .pill{
      display:inline-block;
      font-size:0.8rem;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      margin-bottom:10px;
    }

    /* ---------- Support section polish ---------- */
    .supportDivider{
      height:1px;
      background:var(--border);
      opacity:0.45;
      margin:18px 0 8px;
    }

    .supportWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      margin-top:6px;
      gap:8px;
    }

    /* Make it smaller + clearly "optional" vs Start button */
    .supportBtn{
      max-width:280px;
      padding:12px 18px;
      font-size:0.75rem;
      font-weight:600;
      background:#1A245A;
    }
    .supportBtn:hover{ background:#233070; }

    .supportNote{
      text-align:center;
      font-size:0.8rem;
      max-width:320px;
      opacity:0.85;
    }

    /* Footer even softer */
    .copyright{
      margin-top:20px;
      text-align:center;
      font-size:0.7rem;
      color:var(--muted);
      opacity:0.6;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <!-- Mute button -->
      <button id="muteBtn" class="btn muteBtn" type="button">üîä Sound on</button>

      <!-- Theme music player -->
      <audio id="themePlayer" preload="none"></audio>

      <!-- STEP 1 -->
      <section id="step1">
        <h1>Hi, I‚Äôm Munchkin Boo üëã</h1>
        <p class="muted">I‚Äôm your personal bedtime story application.</p>
        <p class="muted">Press start to begin.</p>
        <button class="btn primary" id="startBtn" type="button">Start</button>
        <div class="status" id="loadStatus">Loading stories‚Ä¶</div>
        <div class="status" id="audioStatus"></div>
      </section>

      <!-- STEP 2 -->
      <section id="step2" class="hidden">
        <h1>What‚Äôs your name?</h1>
        <p class="muted">So I can personalise your story.</p>
        <input id="nameInput" placeholder="Type your name‚Ä¶" autocomplete="given-name" />
        <button class="btn primary" id="toMood" type="button">Continue</button>
        <button class="btn" id="backToWelcome" type="button">Back</button>
      </section>

      <!-- STEP 3 -->
      <section id="step3" class="hidden">
        <h1>What mood are you in?</h1>
        <p class="muted">Choose one:</p>

        <div class="row">
          <button class="btn" data-mood="sleepy" type="button">üò¥ Sleepy</button>
          <button class="btn" data-mood="hungry" type="button">üç™ Hungry</button>
        </div>

        <div class="row">
          <button class="btn" data-mood="naughty" type="button">üòà Naughty</button>
          <button class="btn" data-mood="adventure" type="button">üß≠ Adventure</button>
        </div>

        <button class="btn" id="backToName" type="button">Back</button>
      </section>

      <!-- STEP 4: STORY -->
      <section id="step4" class="hidden">
        <div class="pill" id="modePill">Story</div>
        <img class="storyArt" id="storyArt" alt="" />
        <h2 id="storyTitle"></h2>

        <div class="storyBody" id="storyBody"></div>

        <!-- Interactive choices (only shown for adventure mode) -->
        <div class="choiceList hidden" id="choiceList"></div>

        <div class="topRow">
          <button class="btn primary" id="anotherStory" type="button">Another story</button>
          <button class="btn" id="changeMood" type="button">Change mood</button>
        </div>

        <button class="btn" id="restart" type="button">Restart</button>
      </section>

      <!-- Subtle divider to separate "app" from "support" -->
      <div class="supportDivider"></div>

      <!-- Support (centered + smaller) -->
      <div class="supportWrap">
        <a href="https://buy.stripe.com/bJe28k6ISbeB59yaK5frW00"
           target="_blank"
           rel="noopener"
           class="btn supportBtn">
          Please support Munchkin Boo's development.
        </a>

        <p class="muted supportNote">
          Optional annual subscription to support the platform. This content will always be free.
        </p>
      </div>

      <footer class="copyright">
        ¬© <span id="year"></span> James Ritchie. All rights reserved.
      </footer>

    </div>
  </div>

  <script>
    // ======================
    // State
    // ======================
    const state = {
      name: "",
      mood: "",
      stories: [],
      lastStoryIdByMood: {},
      // interactive story state:
      currentInteractiveStory: null,
      currentNodeId: null
    };

    const steps = ["step1","step2","step3","step4"];
    function show(id){
      steps.forEach(s => document.getElementById(s).classList.toggle("hidden", s !== id));
    }

    function cleanName(input){
      const trimmed = (input || "").trim();
      const safe = trimmed.replace(/[^a-zA-Z '-]/g, "");
      return safe.slice(0, 30) || "";
    }

    function pickRandom(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function pickStoryForMood(mood){
      const options = state.stories.filter(s => s.mood === mood);
      if (!options.length) return null;

      const lastId = state.lastStoryIdByMood[mood] || null;
      if (options.length === 1) return options[0];

      let picked;
      do { picked = pickRandom(options); }
      while (picked.id === lastId);

      state.lastStoryIdByMood[mood] = picked.id;
      return picked;
    }

    function setModePill(text){
      document.getElementById("modePill").textContent = text;
    }

    function renderArtTitle(story){
      const art = document.getElementById("storyArt");
      art.onerror = () => console.log("Image failed to load:", art.src);
      art.src = story.art || "";
      art.alt = story.title || "";

      document.getElementById("storyTitle").textContent = story.title || "";
    }

    function renderParagraphs(paragraphArray){
      const safeName = state.name || "Friend";
      const body = document.getElementById("storyBody");
      body.innerHTML = (paragraphArray || []).map(p => {
        const filled = String(p).replaceAll("{{name}}", safeName);
        return `<p>${filled}</p>`;
      }).join("");
    }

    // ======================
    // Interactive (choose-your-own) rendering
    // ======================
    function startInteractiveStory(story){
      state.currentInteractiveStory = story;
      state.currentNodeId = story.start;

      setModePill("Adventure");
      document.getElementById("anotherStory").textContent = "Start over";
      document.getElementById("choiceList").classList.remove("hidden");

      renderArtTitle(story);
      renderInteractiveNode();
    }

    function renderInteractiveNode(){
      const story = state.currentInteractiveStory;
      if (!story || !story.nodes) return;

      const node = story.nodes[state.currentNodeId];
      if (!node) return;

      renderParagraphs(node.text || []);

      const choiceList = document.getElementById("choiceList");
      choiceList.innerHTML = "";

      const choices = node.choices || [];
      if (choices.length === 0) {
        choiceList.classList.add("hidden");
      } else {
        choiceList.classList.remove("hidden");
        choices.forEach(ch => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.type = "button";
          btn.textContent = ch.label;
          btn.addEventListener("click", () => {
            state.currentNodeId = ch.next;
            renderInteractiveNode();
          });
          choiceList.appendChild(btn);
        });
      }
    }

    function stopInteractiveStoryState(){
      state.currentInteractiveStory = null;
      state.currentNodeId = null;
      document.getElementById("choiceList").classList.add("hidden");
    }

    // ======================
    // Normal story rendering
    // ======================
    function renderNormalStory(story){
      stopInteractiveStoryState();
      setModePill("Story");
      document.getElementById("anotherStory").textContent = "Another story";

      renderArtTitle(story);
      renderParagraphs(story.text || []);
    }

    function showNoStories(mood){
      stopInteractiveStoryState();
      setModePill("Story");
      document.getElementById("anotherStory").textContent = "Another story";

      document.getElementById("storyTitle").textContent = "No stories yet";
      document.getElementById("storyBody").innerHTML =
        `<p class="muted">No stories found for mood: ${mood}</p>`;
      document.getElementById("storyArt").src = "";
      document.getElementById("storyArt").alt = "";
    }

    async function loadStories(){
      const status = document.getElementById("loadStatus");
      try {
        const res = await fetch("./stories.json");
        if (!res.ok) throw new Error("stories.json not found");
        const data = await res.json();
        state.stories = data.stories || [];
        status.textContent = `Loaded ${state.stories.length} stories ‚úÖ`;
      } catch (err) {
        console.error(err);
        status.textContent = "Couldn‚Äôt load stories. Check stories.json is in the repo root.";
      }
    }

    // ======================
    // Audio: Theme + Mute toggle
    // ======================
    const themePlayer = document.getElementById("themePlayer");
    const muteBtn = document.getElementById("muteBtn");
    const audioStatus = document.getElementById("audioStatus");

    themePlayer.addEventListener("error", () => {
      const code = themePlayer.error?.code;
      const msg =
        code === 1 ? "MEDIA_ERR_ABORTED" :
        code === 2 ? "MEDIA_ERR_NETWORK" :
        code === 3 ? "MEDIA_ERR_DECODE (format/codec)" :
        code === 4 ? "MEDIA_ERR_SRC_NOT_SUPPORTED" :
        "Unknown audio error";
      console.log("Audio error:", msg, themePlayer.src);
      audioStatus.textContent = "Audio error: " + msg;
    });

    themePlayer.addEventListener("playing", () => {
      audioStatus.textContent = "";
    });

    themePlayer.addEventListener("waiting", () => {
      audioStatus.textContent = "Loading sound‚Ä¶";
    });

    themePlayer.muted = (localStorage.getItem("munchkin_muted") === "true");

    function updateMuteButton(){
      muteBtn.textContent = themePlayer.muted ? "üîá Sound off" : "üîä Sound on";
    }
    updateMuteButton();

    muteBtn.addEventListener("click", () => {
      themePlayer.muted = !themePlayer.muted;
      localStorage.setItem("munchkin_muted", themePlayer.muted);
      updateMuteButton();
    });

    function startThemeMusic(){
      themePlayer.pause();
      themePlayer.src = "assets/music/theme-music.mp3";
      themePlayer.loop = true;
      themePlayer.volume = 0.5;
      themePlayer.load();

      const p = themePlayer.play();
      if (p && typeof p.catch === "function") {
        p.catch((err) => {
          console.log("Theme music blocked:", err);
          audioStatus.textContent = "If sound doesn‚Äôt begin, tap üîä then tap Start again.";
        });
      }
    }

    function stopThemeMusic(){
      themePlayer.pause();
      themePlayer.currentTime = 0;
    }

    // ======================
    // Wire up UI
    // ======================
    document.getElementById("startBtn").addEventListener("click", () => {
      startThemeMusic();
      show("step2");
    });

    document.getElementById("backToWelcome").addEventListener("click", () => show("step1"));

    document.getElementById("toMood").addEventListener("click", () => {
      const nm = cleanName(document.getElementById("nameInput").value);
      if(!nm) return;
      state.name = nm;
      localStorage.setItem("munchkin_name", nm);
      show("step3");
    });

    document.getElementById("backToName").addEventListener("click", () => show("step2"));

    document.getElementById("step3").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-mood]");
      if(!btn) return;

      state.mood = btn.getAttribute("data-mood");
      const story = pickStoryForMood(state.mood);

      if(!story){
        showNoStories(state.mood);
        show("step4");
        return;
      }

      if (story.type === "choose_your_own" && story.nodes && story.start) {
        startInteractiveStory(story);
        show("step4");
        return;
      }

      renderNormalStory(story);
      show("step4");
    });

    document.getElementById("anotherStory").addEventListener("click", () => {
      if (state.currentInteractiveStory) {
        state.currentNodeId = state.currentInteractiveStory.start;
        document.getElementById("choiceList").classList.remove("hidden");
        renderInteractiveNode();
        return;
      }

      const story = pickStoryForMood(state.mood);
      if (!story) return;

      if (story.type === "choose_your_own" && story.nodes && story.start) {
        startInteractiveStory(story);
      } else {
        renderNormalStory(story);
      }
    });

    document.getElementById("changeMood").addEventListener("click", () => show("step3"));

    document.getElementById("restart").addEventListener("click", () => {
      state.name = "";
      state.mood = "";
      stopInteractiveStoryState();
      document.getElementById("nameInput").value = "";
      stopThemeMusic();
      show("step1");
    });

    document.getElementById("nameInput").value = localStorage.getItem("munchkin_name") || "";

    // Copyright year
    document.getElementById("year").textContent = new Date().getFullYear();

    // Boot
    loadStories();
    show("step1");
  </script>
</body>
</html>
